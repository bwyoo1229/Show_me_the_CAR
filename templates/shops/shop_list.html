{% extends 'base.html' %}
{% load static %}

{% block page_name %}
    Detail
{% endblock page_name %}


{% block content %}

<div>현재 사용자: {{ user.username }}</div>
    <form action="" method="GET">
        <!-- 엔터로 검색어 입력 받음 -->
        <input type="text" name="q" placeholder="search">
    </form>
    {% for shop in shops %}
        <div>
            <a href="{% url 'shops:give_rating' shop.id %}">{{ shop.name }}</a>
            <!-- 좋아요 기능, user가 heart를 눌렀을 때, 대리점의 like_users list에 있으면 list에서 삭제되고 없으면 추가된다 -->
            <a href="{% url 'shops:like' shop.id %}">
              {% if user in shop.like_users.all %}
                <a href="{% url 'shops:like' shop.id %}"><i class="fas fa-heart"></i></a>
              {% else %}
                <a href="{% url 'shops:like' shop.id %}"><i class="far fa-heart"></i></a>
              {% endif %}
            </a>
            <!-- 지도 보기를 누르면 지도 open, 접기하면 close -->
            <input type="button" value="지도 보기" onclick="
                var target=document.querySelector('#map');
                if(this.value==='지도 보기'){
                    target.style.display = 'block';
                    this.value = '지도 접기';
                }
                else{
                    target.style.display = 'none';
                    this.value = '지도 보기';
                }
            ">
        </div>
    {% endfor %}

    <!-- 지도 api -->
    <div id="map" style="width:50%;height:400px;"></div>
    <!--<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>-->
    <!-- <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=026187f5dea33f252d5fd79abc6dd270&libraries=clusterer"></script> -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=026187f5dea33f252d5fd79abc6dd270&libraries=clusterer"></script>
    <script
  src="https://code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"></script>

    <script>
        // 일단 보류
        /*
        var mapContainer = document.getElementById('map'), // 지도를 표시할 div
            mapOption = {
                center: new kakao.maps.LatLng(36.450701, 127.570667), // 지도의 중심좌표
                level: 14 // 지도의 확대 레벨
            };

        // 지도를 생성합니다
        var map = new kakao.maps.Map(mapContainer, mapOption);

        // 마커 클러스터러를 생성합니다
        var clusterer = new kakao.maps.MarkerClusterer({
            map: map, // 마커들을 클러스터로 관리하고 표시할 지도 객체
            averageCenter: true, // 클러스터에 포함된 마커들의 평균 위치를 클러스터 마커 위치로 설정
            minLevel: 10 // 클러스터 할 최소 지도 레벨
        });

        // 데이터를 가져오기 위해 jQuery를 사용합니다
        // 데이터를 가져와 마커를 생성하고 클러스터러 객체에 넘겨줍니다
        $.get("/gitKra/SMT_CAR/kia_data_w_latlng.csv", function(data) {
            // 데이터에서 좌표 값을 가지고 마커를 표시합니다
            // 마커 클러스터러로 관리할 마커 객체는 생성할 때 지도 객체를 설정하지 않습니다
            var markers = $(data.positions).map(function(i, position) {
                return new kakao.maps.Marker({
                    position : new kakao.maps.LatLng(position.lat, position.lng)
                });
            });

            // 클러스터러에 마커들을 추가합니다
            clusterer.addMarkers(markers);
        });
        */

        /*
        var csvfile = "kia_data_latlng.csv";

            $.get(csvfile, function (data) {
                var csvdata = Papa.parse(data);
                console.log(csvdata);
            });
        */





        var map = new kakao.maps.Map(document.getElementById('map'), { // 지도를 표시할 div
                center : new kakao.maps.LatLng(36.2683, 127.6358), // 지도의 중심좌표
                level : 14 // 지도의 확대 레벨
        });

        var clusterer = new kakao.maps.MarkerClusterer({
            map: map, // 마커들을 클러스터로 관리하고 표시할 지도 객체
            averageCenter: true, // 클러스터에 포함된 마커들의 평균 위치를 클러스터 마커 위치로 설정
            minLevel: 10 // 클러스터 할 최소 지도 레벨
        });

        // 주소로 좌표를 검색합니다
        const data = $.getJSON("{% static "kia_data_latlng.json" %}", function(data) {
            // 데이터에서 좌표 값을 가지고 마커를 표시합니다
            // 마커 클러스터러로 관리할 마커 객체는 생성할 때 지도 객체를 설정하지 않습니다
            var marker = $(data.positions).map(function (i, position) {
                return new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(position.lat, position.lng)
                });
            });

            clusterer.addMarkers(marker);
        });





    </script>
{% endblock %}